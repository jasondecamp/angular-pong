angular.module("angular-pong",["ngSanitize","ngAnimate"]).directive("pongCourt",function(){return{restrict:"E",controller:"pongController",scope:{options:"=?"},template:'<pong-ball x="{{ball.x}}" y="{{ball.y}}"></pong-ball><pong-paddle side="left" y="{{paddles.left.y}}"></pong-paddle><pong-paddle side="right" y="{{paddles.right.y}}"></pong-paddle><div class="score"><span class="left" ng-class="{winner:scores.left==11}" ng-bind="scores.left"></span><span class="divider">:</span><span class="right" ng-class="{winner:scores.right==11}" ng-bind="scores.right"></span></div><span class="message" ng-show="message" ng-bind-html="message"></span>'}}).directive("pongBall",function(){return{restrict:"E",require:"^pongCourt",link:function(t,e,i){e.addClass("ball"),e.css("height",t.ball.height),e.css("width",t.ball.width),t.$watch(function(){return i.x},function(t){e.css("left",t+"px")}),t.$watch(function(){return i.y},function(t){e.css("top",t+"px")})}}}).directive("pongPaddle",function(){return{restrict:"E",require:"^pongCourt",link:function(t,e,i){e.addClass("paddle"),e.css("height",t.paddles.height+"px"),e.css("width",t.paddles.width+"px"),"left"==i.side&&e.css("float","left"),"right"==i.side&&e.css("float","right"),t.$watch(function(){return i.y},function(t){e.css("top",t+"px")})}}}).controller("pongController",["$scope","$element","$attrs","$interval","$timeout","$sce",function(t,e,i,n,o,l){function a(){if(!t.active){if(t.gameover)return void(t.message=k.end);t.active=!0,C&&o.cancel(C),t.message=null;var e=1;if(void 0===$){var i=["left","right"];$=i[Math.floor(10*Math.random())%2]}t.ball.x=court.clientWidth-t.ball.width-1,t.ball.y=t.paddles.center("right"),t.ball.velocities.x=v("x"),t.ball.velocities.y=v("y"),"right"==$?(t.ball.x=1,t.ball.y=t.paddles.center("left"),0<=t.ball.velocities.x&&(e=-1)):0>t.ball.velocities.x&&(e=-1),t.ball.velocities.x*=e,s()}}function s(){var e;angular.isDefined(S.ball)||(S.ball=n(function(){t.paddles.auto("left");var i=(new Date).getTime(),n=e?e-i:0;e=i,c("y",n),d("y",t.ball.y),c("x",n),d("x",t.ball.x)},10))}function r(){angular.isDefined(S.ball)&&(g("ball"),S.ball=void 0)}function c(e,i){var n=t.ball.velocities[e]/1e3;t.ball[e]+=Math.round(i*n)}function d(e,i){function n(e,i){var n={x:{max:court.clientWidth-t.ball.width-t.paddles.width,min:t.paddles.width},y:{max:court.clientHeight-t.ball.height,min:0}};t.ball[e]=2*n[e][i]-t.ball[e],t.ball.velocities[e]*=-1,"y"==e&&h("wall"),"x"==e&&h("paddle")}if(t.ball.touchesTop())return void n("y","min");if(t.ball.touchesBottom())return void n("y","max");if(t.ball.touchesPaddle()){var o=t.ball.direction();return t.ball.redirect(o),void("left"==o?n("x","min"):n("x","max"))}return t.ball.isOut()?(t.ball.setFinalX(),$=t.ball.direction(),t.scores[f($)]++,h("out"),p(f($)),t.active=!1,void r()):void 0}function u(){return!angular.isDefined(S.ball)}function h(t){0!==w.soundOn&&x[t]&&x[t].play()}function p(e){return C&&o.cancel(C),11==t.scores[e]?(t.gameover=!0,void(t.message='GAME OVER <span class="hint">Well that was fun... don\'t you have better things to do, human?</span>')):(w.smack&&"right"==e?t.message=k.human[Math.floor((k.human.length-1)*Math.random())]:w.smack&&"left"==e&&(t.message=k.ai[Math.floor((k.ai.length-1)*Math.random())]),void(t.message&&(C=o(function(){t.message=null},5e3))))}function g(t){angular.isDefined(t)&&angular.isDefined(S[t])&&(n.cancel(S[t]),angular.isFunction(A[t+"Stop"])&&A[t+"Stop"](),S[t]=void 0)}function f(t){var e={left:"right",right:"left"};return e[t]?e[t]:void 0}function v(t){var e="Height",i=3;"x"==t&&(e="Width",i=2);var n=court["client"+e],o=n/2,l=m(),a=y(i),s=1-100/n,r=a*s*l;return Math.round(o+r)}function y(t){return Math.floor(Math.random().toPrecision(t)*Math.pow(10,t))}function m(){var t=y(1);return t%2?1:-1}court=e.addClass("pong-court")[0];var b={soundOn:1,paddleSpeed:50,keyMap:{13:"enter",27:"escape",38:"rightup",40:"rightdown"},smack:!1,assets:"assets/"},w=angular.extend({},b,t.options||{}),x={wall:new Audio(w.assets+"pong_8bit_wall.wav"),paddle:new Audio(w.assets+"pong_8bit_paddle.wav"),out:new Audio(w.assets+"pong_8bit_out.wav")},k={ai:["The robots will always win.","I bet you're the one that gets lost in the guided tour.","Your aim is so poor Bono is holding a charity concert for it.","Maybe you should go back to farmville","Are you not entertained!?","Need some help? Pressing ctrl+alt+del will give you a power-up..."],human:["Pshhh, lucky shot","Hey, I wasn't looking!","Timeout! I called a timeout!?!","I'm gonna remember this... just please don't delete your cookies.","Ok, time for me to stop holding back..."],start:'Shall we play a game? <span class="hint">press enter to start</hint>',end:'GAME OVER<span class="hint">press esc to reset</hint>'},M=function(){t.scores={left:0,right:0},t.gameover=!1,t.active=!1,t.message=k.start};M();var $,C,H=Math.floor(.15*court.clientHeight),D=court.clientHeight-H,S={},A={enter:function(){t.active||a()},escape:function(){t.gameover&&M(),t.active&&(u()?s():r())},rightup:function(){t.paddles.move("right","up")},rightdown:function(){t.paddles.move("right","down")},rightupStop:function(){t.paddles.resetVelocity("right")},rightdownStop:function(){t.paddles.resetVelocity("right")},leftup:function(){t.paddles.move("left","up")},leftdown:function(){t.paddles.move("left","down")},leftupStop:function(){t.paddles.resetVelocity("left")},leftdownStop:function(){t.paddles.resetVelocity("left")}};t.paddles={height:H,width:15,left:{y:D/2,velocity:0},right:{y:D/2,velocity:0},move:function(e,i){if(!(u()&&t.active||(this[e].ts=(new Date).getTime(),angular.isDefined(S[e+i])))){var o="up"==i?-1:1;S[e+i]=n(function(){1==o&&D<=t.paddles[e].y||-1==o&&0>=t.paddles[e].y||(t.paddles[e].velocity>=200?t.paddles[e].velocity=200:t.paddles[e].velocity++,t.paddles[e].y+=(w.paddleSpeed/5+t.paddles[e].velocity/10)*o,t.paddles[e].direction=i)},10)}},top:function(t){return this[t].y},bottom:function(t){return this[t].y+this.height},face:function(t){var e=this.width;return"right"==t&&(e=court.clientWidth-this.width),e},center:function(t){return this[t].y+this.height/2},resetVelocity:function(e){t.paddles[e].velocity=0},auto:function(e){var i=t.ball.y>this.center(e)?"down":"up";if(t.ball.x<court.clientHeight/10&&y(2)<=25)"up"==i?g(e+"down"):"down"==i&&g(e+"up"),angular.isDefined(S[e+i])||this.move(e,i);else if(t.ball.x<court.clientHeight/2&&y(2)<=95||y(2)<=5){if("up"==i?g(e+"down"):"down"==i&&g(e+"up"),this.top(e)<t.ball.y&&t.ball.y<this.bottom(e))return;angular.isDefined(S[e+i])||this.move(e,i)}else g(e+"down"),g(e+"up")}},t.ball={height:15,width:15,x:-50,y:Number(court.clientHeight/2),velocities:{x:0,y:0},touchesTop:function(){return this.y<=0},touchesBottom:function(){return court.clientHeight<=this.y+this.height},touchesLeft:function(){return this.x<=0},touchesRight:function(){return court.clientWidth<=this.x+this.width},touchesPaddle:function(){var e=this.direction(),i=t.paddles.face(e),n=t.paddles.top(e),o=t.paddles.bottom(e),l="left"==e?1:-1;return this.x*l+i<=t.paddles.width&&n<this.y+this.height&&this.y<o},isOut:function(){return this.touchesLeft()||this.touchesRight()?this.touchesLeft()||this.touchesRight():void 0},redirect:function(e){var i="up"==t.paddles[e].direction?1:-1;this.velocities.y+=t.paddles[e].velocity*i*10+v("y")/8,this.velocities.y=this.velocities.y>0?Math.min(this.velocities.y,2*court.clientHeight):Math.max(this.velocities.y,-2*court.clientHeight),this.velocities.x+=.05*this.velocities.x},direction:function(){var t="left";return this.velocities.x<0&&(t="right"),t},setFinalX:function(){this.x=0,"right"==this.direction()&&(this.x=court.clientWidth-this.width)}},angular.element(document).on("keydown .pong",function(e){angular.isFunction(A[w.keyMap[e.keyCode]])&&(A[w.keyMap[e.keyCode]](),t.$apply())}),angular.element(document).on("keyup .pong",function(e){angular.isFunction(A[w.keyMap[e.keyCode]])&&(g(w.keyMap[e.keyCode]),t.$apply())}),t.$on("$destroy",function(){angular.element(document).off(".pong")})}]);